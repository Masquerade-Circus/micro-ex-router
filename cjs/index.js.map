{"version":3,"file":"index.js","sources":["../lib/index.js"],"sourcesContent":["let micro = require('micro'),\n    urlencodedBodyParser = require('urlencoded-body-parser'),\n    url = require('url'),\n    qs = require('querystring');\n\nlet acceptedMethods = ['get', 'post', 'put', 'patch', 'delete', 'head', 'options', 'use'];\n\n/**\n * Handles the mix of single and array of middlewares\n * @method parseMiddlewares\n * @param  {Function|Array}         middlewares     // Middleware or array of middlewares\n * @param  {Array}                  [array=[]]      // The array to store the final list of middlewares\n * @return {Array}                                  // The final list of middlewares\n */\nlet parseMiddlewares = (middlewares, array = []) => {\n    if (typeof middlewares === 'function') {\n        array.push(middlewares);\n        return array;\n    }\n\n    let i = 0, l = middlewares.length;\n    for (; i < l; i++) {\n        if (Array.isArray(middlewares[i])) {\n            parseMiddlewares(middlewares[i], array);\n        }\n\n        if (!Array.isArray(middlewares[i])) {\n            array.push(middlewares[i]);\n        }\n    }\n    return array;\n};\n\n/**\n * Adds a path to a router\n * @method addPath\n * @param  {Router} router              The router in which to add the path\n * @param  {String} method              The method that will handle this path\n * @param  {Array} args                The mixed params (String|Function|Array)\n */\nlet addPath = (router, method, args) => {\n    let path, middlewares;\n\n    // Get the first argument\n    if (typeof args[0] === 'string') {\n        path = args.shift();\n    }\n\n    // Parse middlwares to handle mixed arrays of middlwares and sequenced middlwares\n    middlewares = parseMiddlewares(args);\n\n    // If the path wasn't set before, set the regexp and params list\n    if (path !== undefined && router.regexpList[path] === undefined) {\n        // Find the params like express params\n        let params = path.match(/:(\\w+)?/gi) || [];\n\n        // Set the names of the params found\n        for (let i in params) {\n            params[i] = params[i].replace(':', '');\n        }\n\n        // Set the object to the path\n        router.regexpList[path] = {\n            regexp : new RegExp('^' + path.replace(/:(\\w+)/gi, '([^\\\\s\\\\/]+)').replace(/\\*/g, '.*')  + '/?(\\\\?.*)?$', 'gi'),\n            params: params\n        }\n    }\n\n    // Add the path to the paths list\n    router.paths.push({\n        method: method,\n        path: path,\n        middlewares: middlewares\n    });\n\n    return router;\n};\n\n/**\n * Parses the body according with its content-type\n * @method parseBody\n * @param  {Request}    req\n * @return {Void}\n */\nlet parseBody = async (req) => {\n    /**\n     * Set the params property to an empty object\n     * @type {Object}\n     */\n    req.params = req.params || {};\n\n    /**\n     * Set the body property to undefined\n     * @type {Undefined}\n     */\n    req.body = undefined;\n\n    /**\n     * Set the query object\n     * The object returned by the querystring.parse() method does not prototypically inherit from the JavaScript Object.\n     * So we create a new object and merge its properties\n     * @type {Object}\n     */\n    req.query = Object.assign({}, qs.parse(url.parse(req.url).query));\n\n    /**\n     * If the method is other than get try to parse the body\n     * @method if\n     * @param  {Request} req\n     */\n    if (req.method.toLowerCase() !== 'get') {\n        let type = req.headers['content-type'],\n            parsed = false,\n            options = {\n                limit: opt.limit,\n                encoding: opt.encoding\n            },\n            body;\n\n        try {\n            if (type === 'application/json') {\n                parsed = true;\n                body = await micro.json(req, options);\n            }\n\n            if (type === 'application/x-www-form-urlencoded' && !parsed) {\n                parsed = true;\n                body = await urlencodedBodyParser(req, options);\n            }\n\n            if (type === 'text/html' && !parsed) {\n                parsed = true;\n                body = await micro.text(req, options);\n            }\n\n            if (!parsed) {\n                body = await micro.buffer(req, options);\n            }\n        } catch (e) {\n\n        }\n\n        req.body = body;\n    }\n};\n\nlet RouterFactory = (options = {}) => {\n    let opt = Object.assign({}, { limit: '1mb', encoding: 'utf8' }, options);\n\n    /**\n     * new Rotuer\n     * @param  {Request}    req     NodeJs Request object\n     * @param  {Response}   res     NodeJs Response object\n     * @return {Function}           The async function to be passed to micro\n     */\n    let Router = async function (req, res) {\n        let method = req.method.toLowerCase(),\n            params = {},\n            middlewares = [],\n            response,\n            i = 0,\n            l = Router.paths.length;\n\n        for (; i < l; i++) {\n            let path = Router.paths[i];\n            if (method !== path.method && path.method !== 'use') {\n                continue;\n            }\n\n            if ((path.method === 'use' || method === path.method) && path.path === undefined) {\n                middlewares = parseMiddlewares(path.middlewares, middlewares);\n                continue;\n            }\n\n            let matches = Router.regexpList[path.path].regexp.exec(req.url);\n            Router.regexpList[path.path].regexp.lastIndex = -1;\n            if (Array.isArray(matches)) {\n                matches.shift();\n                let l = Router.regexpList[path.path].params.length;\n                for (; l--;) {\n                    if (params[Router.regexpList[path.path].params[l]] === undefined) {\n                        params[Router.regexpList[path.path].params[l]] = matches[l];\n                    }\n                }\n                middlewares = parseMiddlewares(path.middlewares, middlewares);\n            }\n        }\n\n        if (middlewares.length > 0) {\n            await parseBody(req);\n            req.params = params;\n\n            let i = 0, l = middlewares.length;\n            // call sequentially every middleware\n            for (; i < l; i++) {\n                response = await middlewares[i](req, res);\n                // If there is a response or a response was sent to the client\n                // break the for block\n                if (response !== undefined || res.headersSent) {\n                    break;\n                }\n            }\n\n            // If there is a response and no other response was sent to the client\n            // return the response\n            if (response !== undefined && !res.headersSent) {\n                return response;\n            }\n        }\n\n        // If no response was sent to the client throw an error\n        if (!res.headersSent) {\n            throw new Error(`The url ${req.url} requested by ${method}, wasn't found`);\n        }\n    };\n\n    /**\n     * Where to store the paths and its middlewares\n     * @type {Object}\n     */\n    Router.paths = [];\n\n    /**\n     * Where to store the regexp and params list for the paths\n     * @type {[type]}\n     */\n    Router.regexpList = {};\n\n    /**\n     * For each accepted method, add the method to the router\n     * @type {Array}\n     */\n    acceptedMethods.map(method => {\n        Router[method] = (...args) => addPath(Router, method, args);\n    });\n\n    /**\n     * Return the new router\n     * @type {Router}\n     */\n    return Router;\n};\n\nmodule.exports = RouterFactory;\n"],"names":["acceptedMethods","parseMiddlewares","middlewares","array","push","i","l","length","Array","isArray","addPath","router","method","args","path","shift","undefined","regexpList","params","match","replace","RegExp","paths","parseBody","req","body","query","Object","assign","qs","parse","url","toLowerCase","headers","parsed","options","opt","limit","encoding","type","micro","json","urlencodedBodyParser","text","buffer","RouterFactory","Router","res","response","regexp","exec","lastIndex","matches","headersSent","Error","map"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAKA,IAAIA,kBAAkB,CAAC,KAAD,EAAQ,MAAR,EAAgB,KAAhB,EAAuB,OAAvB,EAAgC,QAAhC,EAA0C,MAA1C,EAAkD,SAAlD,EAA6D,KAA7D,CAAtB;;;;;;;;;AASA,IAAIC,mBAAmB,SAAnBA,gBAAmB,CAACC,WAAD,EAA6B;QAAfC,KAAe,uEAAP,EAAO;;QAC5C,OAAOD,WAAP,KAAuB,UAA3B,EAAuC;cAC7BE,IAAN,CAAWF,WAAX;eACOC,KAAP;;;QAGAE,IAAI,CAAR;QAAWC,IAAIJ,YAAYK,MAA3B;WACOF,IAAIC,CAAX,EAAcD,GAAd,EAAmB;YACXG,MAAMC,OAAN,CAAcP,YAAYG,CAAZ,CAAd,CAAJ,EAAmC;6BACdH,YAAYG,CAAZ,CAAjB,EAAiCF,KAAjC;;;YAGA,CAACK,MAAMC,OAAN,CAAcP,YAAYG,CAAZ,CAAd,CAAL,EAAoC;kBAC1BD,IAAN,CAAWF,YAAYG,CAAZ,CAAX;;;WAGDF,KAAP;CAhBJ;;;;;;;;;AA0BA,IAAIO,UAAU,SAAVA,OAAU,CAACC,MAAD,EAASC,MAAT,EAAiBC,IAAjB,EAA0B;QAChCC,aAAJ;QAAUZ,oBAAV;;;QAGI,OAAOW,KAAK,CAAL,CAAP,KAAmB,QAAvB,EAAiC;eACtBA,KAAKE,KAAL,EAAP;;;;kBAIUd,iBAAiBY,IAAjB,CAAd;;;QAGIC,SAASE,SAAT,IAAsBL,OAAOM,UAAP,CAAkBH,IAAlB,MAA4BE,SAAtD,EAAiE;;YAEzDE,SAASJ,KAAKK,KAAL,CAAW,WAAX,KAA2B,EAAxC;;;aAGK,IAAId,CAAT,IAAca,MAAd,EAAsB;mBACXb,CAAP,IAAYa,OAAOb,CAAP,EAAUe,OAAV,CAAkB,GAAlB,EAAuB,EAAvB,CAAZ;;;;eAIGH,UAAP,CAAkBH,IAAlB,IAA0B;oBACb,IAAIO,MAAJ,CAAW,MAAMP,KAAKM,OAAL,CAAa,UAAb,EAAyB,cAAzB,EAAyCA,OAAzC,CAAiD,KAAjD,EAAwD,IAAxD,CAAN,GAAuE,aAAlF,EAAiG,IAAjG,CADa;oBAEdF;SAFZ;;;;WAOGI,KAAP,CAAalB,IAAb,CAAkB;gBACNQ,MADM;cAERE,IAFQ;qBAGDZ;KAHjB;;WAMOS,MAAP;CAnCJ;;;;;;;;AA4CA,IAAIY;wDAAY,iBAAOC,GAAP;;;;;;;;;;4BAKRN,MAAJ,GAAaM,IAAIN,MAAJ,IAAc,EAA3B;;;;;;4BAMIO,IAAJ,GAAWT,SAAX;;;;;;;;4BAQIU,KAAJ,GAAYC,OAAOC,MAAP,CAAc,EAAd,EAAkBC,YAAGC,KAAH,CAASC,IAAID,KAAJ,CAAUN,IAAIO,GAAd,EAAmBL,KAA5B,CAAlB,CAAZ;;;;;;;;8BAOIF,IAAIZ,MAAJ,CAAWoB,WAAX,OAA6B,KA1BrB;;;;;4BAAA,GA2BGR,IAAIS,OAAJ,CAAY,cAAZ,CA3BH,EA4BJC,MA5BI,GA4BK,KA5BL,EA6BJC,OA7BI,GA6BM;mCACCC,IAAIC,KADL;sCAEID,IAAIE;yBA/Bd,EAiCJb,IAjCI;;;8BAoCAc,SAAS,kBApCT;;;;;iCAqCS,IAAT;;+BACaC,MAAMC,IAAN,CAAWjB,GAAX,EAAgBW,OAAhB,CAtCb;;;4BAAA;;;8BAyCAI,SAAS,mCAAT,IAAgD,CAACL,MAzCjD;;;;;iCA0CS,IAAT;;+BACaQ,qBAAqBlB,GAArB,EAA0BW,OAA1B,CA3Cb;;;4BAAA;;;8BA8CAI,SAAS,WAAT,IAAwB,CAACL,MA9CzB;;;;;iCA+CS,IAAT;;+BACaM,MAAMG,IAAN,CAAWnB,GAAX,EAAgBW,OAAhB,CAhDb;;;4BAAA;;;4BAmDCD,MAnDD;;;;;;+BAoDaM,MAAMI,MAAN,CAAapB,GAAb,EAAkBW,OAAlB,CApDb;;;4BAAA;;;;;;;;;;;;4BA0DJV,IAAJ,GAAWA,IAAX;;;;;;;;KA1DJ;;;;;GAAJ;;AA8DA,IAAIoB,gBAAgB,SAAhBA,aAAgB,GAAkB;QAAjBV,OAAiB,uEAAP,EAAO;;QAC9BC,MAAMT,OAAOC,MAAP,CAAc,EAAd,EAAkB,EAAES,OAAO,KAAT,EAAgBC,UAAU,MAA1B,EAAlB,EAAsDH,OAAtD,CAAV;;;;;;;;QAQIW;6DAAS,kBAAgBtB,GAAhB,EAAqBuB,GAArB;;;;;;;kCAAA,GACIvB,IAAIZ,MAAJ,CAAWoB,WAAX,EADJ,EAELd,MAFK,GAEI,EAFJ,EAGLhB,WAHK,GAGS,EAHT,EAIL8C,QAJK,WAKL3C,CALK,GAKD,CALC,EAMLC,CANK,GAMDwC,OAAOxB,KAAP,CAAaf,MANZ;;;kCAQFF,IAAIC,CARF;;;;;gCAAA,GASMwC,OAAOxB,KAAP,CAAajB,CAAb,CATN;;kCAUDO,WAAWE,KAAKF,MAAhB,IAA0BE,KAAKF,MAAL,KAAgB,KAVzC;;;;;;;;kCAcD,CAACE,KAAKF,MAAL,KAAgB,KAAhB,IAAyBA,WAAWE,KAAKF,MAA1C,KAAqDE,KAAKA,IAAL,KAAcE,SAdlE;;;;;0CAeaf,iBAAiBa,KAAKZ,WAAtB,EAAmCA,WAAnC,CAAd;;;;mCAfC,GAmBS4C,OAAO7B,UAAP,CAAkBH,KAAKA,IAAvB,EAA6BmC,MAA7B,CAAoCC,IAApC,CAAyC1B,IAAIO,GAA7C,CAnBT;;mCAoBEd,UAAP,CAAkBH,KAAKA,IAAvB,EAA6BmC,MAA7B,CAAoCE,SAApC,GAAgD,CAAC,CAAjD;gCACI3C,MAAMC,OAAN,CAAc2C,OAAd,CAAJ,EAA4B;wCAChBrC,KAAR;kCADwB,GAEhB+B,OAAO7B,UAAP,CAAkBH,KAAKA,IAAvB,EAA6BI,MAA7B,CAAoCX,MAFpB;;uCAGjBD,IAAP,GAAa;wCACLY,OAAO4B,OAAO7B,UAAP,CAAkBH,KAAKA,IAAvB,EAA6BI,MAA7B,CAAoCZ,EAApC,CAAP,MAAmDU,SAAvD,EAAkE;+CACvD8B,OAAO7B,UAAP,CAAkBH,KAAKA,IAAvB,EAA6BI,MAA7B,CAAoCZ,EAApC,CAAP,IAAiD8C,QAAQ9C,EAAR,CAAjD;;;8CAGML,iBAAiBa,KAAKZ,WAAtB,EAAmCA,WAAnC,CAAd;;;;+BA7BC;;;;;kCAiCLA,YAAYK,MAAZ,GAAqB,CAjChB;;;;;;mCAkCCgB,UAAUC,GAAV,CAlCD;;;gCAmCDN,MAAJ,GAAaA,MAAb;;8BAnCK,GAqCG,CArCH,EAqCMZ,GArCN,GAqCUJ,YAAYK,MArCtB;;;;kCAuCEF,KAAIC,GAvCN;;;;;;mCAwCgBJ,YAAYG,EAAZ,EAAemB,GAAf,EAAoBuB,GAApB,CAxChB;;;oCAAA;;kCA2CGC,aAAahC,SAAb,IAA0B+B,IAAIM,WA3CjC;;;;;;;;gCAAA;;;;;kCAkDDL,aAAahC,SAAb,IAA0B,CAAC+B,IAAIM,WAlD9B;;;;;8DAmDML,QAnDN;;;gCAwDJD,IAAIM,WAxDA;;;;;kCAyDC,IAAIC,KAAJ,cAAqB9B,IAAIO,GAAzB,sBAA6CnB,MAA7C,qBAzDD;;;;;;;;SAAT;;;;;OAAJ;;;;;;WAiEOU,KAAP,GAAe,EAAf;;;;;;WAMOL,UAAP,GAAoB,EAApB;;;;;;oBAMgBsC,GAAhB,CAAoB,kBAAU;eACnB3C,MAAP,IAAiB;8CAAIC,IAAJ;oBAAA;;;mBAAaH,QAAQoC,MAAR,EAAgBlC,MAAhB,EAAwBC,IAAxB,CAAb;SAAjB;KADJ;;;;;;WAQOiC,MAAP;CA9FJ;;AAiGA,YAAiBD,aAAjB;;;;"}